"排版导出" (也常称为 "拼版" 或 "Layout Export") 是一个非常关键的功能，它直接关系到用户能否用普通打印机（如 A4 打印机）高效地打印标签。

这个功能的需求描述如下：

1.0 功能目标与定位
功能名称： 排版导出 (Layout Export)

目标： 允许用户将多个小尺寸的独立标签（无论是来自批量数据的多个不同标签，还是单个标签的多份拷贝）自动排列（拼版）到一张指定的大尺寸纸张（如 A4）上，以便使用标准打印机进行批量打印和裁切。

核心场景： 用户使用 A4/A5 等尺寸的不干胶打印纸，希望在一张纸上打印尽可能多的标签，以节约成本和纸张。

2.0 UI 交互与状态
FR2.1: 激活条件 (Enabling)

在“打印与导出预览”对话框中，排版导出 按钮 (QPushButton) 必须默认处于禁用 (disabled) 状态。

当用户在右侧设置区的 "尺寸" 下拉框 (QComboBox) 中，选择了 "原尺寸" 以外的任何纸张尺寸（例如 "A4 (210×297mm)", "A5 (148×210mm)"）时，排版导出 按钮必须被自动启用 (enabled)。

当用户重新选回 "原尺寸" 时，排版导出 按钮必须再次变为禁用。

FR2.2: 执行动作 (Click Event)

当用户点击已启用的 排版导出 按钮时：

系统必须立即执行“排版计算”（见 4.0 节）。

计算完成后，系统必须刷新左侧的“作品预览区”。

点击此按钮不应关闭对话框，它是一个预览生成步骤。

FR2.3: 预览区状态切换 (Preview State Change)

切换前 (默认状态): 左侧“作品预览区” (PreviewCanvas) 显示的是单个标签的预览。批量分页器 (BatchNavigator，即 < 1 2 ... 8 >) 处于活动状态，用于切换单个标签。

切换后 (点击“排版导出”后):

批量分页器 (BatchNavigator) 必须被隐藏 (setVisible(false)) 或禁用。

作品预览区 (PreviewCanvas) 的内容必须被替换为排版后的大尺寸纸张（例如 A4）的整页预览。

预览区应显示计算出的第一页排版结果（例如，一张A4纸上排列了 8 个标签）。

底部的 页面分页器 (PageNavigator，即 "前往 [ ] 页") 必须被激活，并更新其总页数（例如，如果总共需要 2 张 A4 纸，则总页数为 2）。

FR2.4: 状态重置

如果用户在“排版导出”激活状态下，将“尺寸”改回 "原尺寸"，预览区必须重置回 FR2.3 中的“默认状态”（显示单个标签预览）。

3.0 配置参数 (输入)
为执行排版，系统必须从 UI 获取以下参数：

FR3.1: 目标纸张尺寸 (Target Paper)

来自 "尺寸" (QComboBox) 下拉框。

示例：A4 (210mm × 297mm)。

FR3.2: 源标签尺寸 (Source Label)

来自“作品预览区”左下角的 "尺寸" (QLabel)。

示例：40mm × 35mm。

FR3.3: 标签数据源 (Label Data)

系统必须能处理两种数据源：

批量模式 (Batch Mode): (如图 3306a6) "份数: 8", "范围: 1 到 8"。系统需要处理这 8 个内容不同的标签。

拷贝模式 (Copy Mode): (如图 330e25) "份数: 1", "导出份数: 8"。系统需要处理 8 个内容相同的标签。

总标签数 (Total Labels):

在批量模式下，TotalLabels = (范围结束值 - 范围起始值 + 1) * 导出份数。

在拷贝模式下，TotalLabels = 导出份数。

FR3.4: 布局参数 (Layout Parameters)

系统必须定义（初期可硬编码，后续可开放给用户设置）：

页边距 (Page Margins): 例如：上下左右各 10mm。

标签间距 (Label Spacing): 例如：水平间距 2mm，垂直间距 2mm。

4.0 核心排版逻辑 (计算)
FR4.1: 计算每页容量 (Labels per Page)

系统必须根据 FR3.1, FR3.2, FR3.4 计算出一张目标纸张上最多可以容纳多少个源标签。

计算公式 (示例):

可用宽度 = 纸张宽度 - 左边距 - 右边距

可用高度 = 纸张高度 - 上边距 - 下边距

每行数量 (Cols) = floor( (可用宽度 + 标签间距) / (标签宽度 + 标签间距) )

每列数量 (Rows) = floor( (可用高度 + 标签间距) / (标签高度 + 标签间距) )

每页容量 = Cols * Rows

FR4.2: 计算总页数 (Total Pages)

系统必须根据 FR3.3 和 FR4.1 计算总共需要多少页。

计算公式 (示例):

总页数 = ceil( 总标签数 / 每页容量 )

此结果必须更新 FR2.3 中提到的 页面分页器 (PageNavigator)。

FR4.3: 标签填充逻辑 (Filling Logic)

系统必须按“先行后列”（从左到右，从上到下）的顺序，将 FR3.3 中的标签数据（无论是批量数据还是重复拷贝）依次填充到计算好的页面网格中。

5.0 输出行为 (结果)
FR5.1: 预览切换

如 FR2.3 所述，PreviewCanvas 必须更新为显示排版后的页面。用户必须能通过 PageNavigator 翻页预览所有排版好的页面。

FR5.2: 最终导出/打印

当用户处于“排版预览”状态时：

点击 "下载作品" (QPushButton): 系统必须导出一个单一的、多页的 PDF 文件。每一页都是一张排版好的 A4 页面。

点击 "打印作品" (QPushButton): 系统必须将这个多页的排版作业发送给 QPrinter